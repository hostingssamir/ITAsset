{% extends "base.html" %}

{% block title %}ุงููุณุฎ ุงูุงุญุชูุงุทู - ูุธุงู ุฅุฏุงุฑุฉ ุงูุฃุตูู ุงูุชูููุฉ{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="fas fa-database"></i> ุงููุณุฎ ุงูุงุญุชูุงุทู
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ุงูุฑุฆูุณูุฉ</a></li>
                        <li class="breadcrumb-item">ุงูุฅุฏุงุฑุฉ</li>
                        <li class="breadcrumb-item active">ุงููุณุฎ ุงูุงุญุชูุงุทู</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus-circle"></i> ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉ
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุญูุธ ุฌููุน ุงูุจูุงูุงุช ูุงูุฅุนุฏุงุฏุงุช.
                    </p>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>ููุงุญุธุฉ:</strong> ูููุตุญ ุจุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุจุดูู ุฏูุฑู ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช.
                    </div>

                    <form method="POST" action="{{ url_for('admin.create_backup') }}" id="backupForm">
                        <div class="mb-3">
                            <label class="form-label">ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:</label>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> ุฌููุน ุจูุงูุงุช ุงูุฃุตูู</li>
                                <li><i class="fas fa-check text-success"></i> ุณุฌูุงุช ุงูุตูุงูุฉ</li>
                                <li><i class="fas fa-check text-success"></i> ุจูุงูุงุช ุงููุณุชุฎุฏููู</li>
                                <li><i class="fas fa-check text-success"></i> ุงููุฆุงุช ูุงูููุงูุน</li>
                                <li><i class="fas fa-check text-success"></i> ุจูุงูุงุช ุงูููุธููู ูุงูููุฑุฏูู</li>
                            </ul>
                        </div>

                        <button type="submit" class="btn btn-primary" id="createBackupBtn">
                            <i class="fas fa-download"></i> ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงูููุฌูุฏุฉ -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history"></i> ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงูููุฌูุฏุฉ
                    </h5>
                </div>
                <div class="card-body">
                    <div id="backupsList">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-2"></i>
                            <p class="text-muted">ุฌุงุฑู ุชุญููู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ...</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshBackupsList()">
                            <i class="fas fa-refresh"></i> ุชุญุฏูุซ ุงููุงุฆูุฉ
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="cleanOldBackups()">
                            <i class="fas fa-trash"></i> ุญุฐู ุงููุณุฎ ุงููุฏููุฉ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-database"></i> ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ
                    </h5>
                </div>
                <div class="card-body">
                    <div id="databaseInfo">
                        <div class="text-center py-2">
                            <i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุชุญููู ุงููุนูููุงุช...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> ูุนูููุงุช ูููุฉ ุญูู ุงููุณุฎ ุงูุงุญุชูุงุทู
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-shield-alt text-success"></i> ุงูุฃูุงู</h6>
                            <ul class="list-unstyled small">
                                <li>โข ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ูุญููุธุฉ ูุญููุงู</li>
                                <li>โข ุชุดูู ุฌููุน ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ</li>
                                <li>โข ูููุตุญ ุจูุณุฎูุง ูููุงู ุขูู ุฎุงุฑุฌู</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-clock text-warning"></i> ุงูุชูููุช</h6>
                            <ul class="list-unstyled small">
                                <li>โข ูููุตุญ ุจุงููุณุฎ ุงูุงุญุชูุงุทู ููููุงู</li>
                                <li>โข ุงููุณุฎ ุงููุฏููุฉ ุชูุญุฐู ุชููุงุฆูุงู ุจุนุฏ 30 ููู</li>
                                <li>โข ูููู ุฅูุดุงุก ูุณุฎุฉ ูู ุฃู ููุช</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-undo text-info"></i> ุงูุงุณุชุนุงุฏุฉ</h6>
                            <ul class="list-unstyled small">
                                <li>โข ุงุถุบุท ุฒุฑ ุงูุงุณุชุนุงุฏุฉ <i class="fas fa-undo text-success"></i> ุจุฌุงูุจ ุงููุณุฎุฉ</li>
                                <li>โข ูุชู ุฅูุดุงุก ูุณุฎุฉ ุฃูุงู ุชููุงุฆูุงู</li>
                                <li>โข ูููุตุญ ุจุฅุนุงุฏุฉ ุชุดุบูู ุงููุธุงู ุจุนุฏ ุงูุงุณุชุนุงุฏุฉ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ุชุญููู ูุงุฆูุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    refreshBackupsList();
    loadDatabaseInfo();
});

// ุชุญููู ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
function loadDatabaseInfo() {
    fetch('/admin/backup/info')
        .then(response => response.json())
        .then(data => {
            const databaseInfo = document.getElementById('databaseInfo');
            
            if (data.success) {
                const dbSize = formatFileSize(data.current_db_size);
                const backupSize = formatFileSize(data.total_backup_size);
                
                databaseInfo.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6><i class="fas fa-database text-primary"></i> ูุงุนุฏุฉ ุงูุจูุงูุงุช</h6>
                                <p class="mb-1"><strong>${data.current_db_path || 'ุบูุฑ ูุญุฏุฏ'}</strong></p>
                                <small class="text-muted">ุงูุญุฌู: ${dbSize}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6><i class="fas fa-archive text-success"></i> ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ</h6>
                                <p class="mb-1"><strong>${data.backup_count} ูุณุฎุฉ</strong></p>
                                <small class="text-muted">ุงูุญุฌู ุงูุฅุฌูุงูู: ${backupSize}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6><i class="fas fa-folder text-warning"></i> ูุฌูุฏ ุงููุณุฎ</h6>
                                <p class="mb-1"><strong>${data.backup_dir_exists ? 'ููุฌูุฏ' : 'ุบูุฑ ููุฌูุฏ'}</strong></p>
                                <small class="text-muted">backups/</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6><i class="fas fa-shield-alt text-info"></i> ุงูุญุงูุฉ</h6>
                                <p class="mb-1"><strong>${data.current_db_path ? 'ุฌุงูุฒ' : 'ุฎุทุฃ'}</strong></p>
                                <small class="text-muted">${data.current_db_path ? 'ูููู ุฅูุดุงุก ุงููุณุฎ' : 'ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช'}</small>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                databaseInfo.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        ุชุนุฐุฑ ุชุญููู ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('databaseInfo').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
                </div>
            `;
        });
}

// ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
function refreshBackupsList() {
    // ุชุญุฏูุซ ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃูุถุงู
    loadDatabaseInfo();
    
    fetch('/admin/backup/list')
        .then(response => response.json())
        .then(data => {
            const backupsList = document.getElementById('backupsList');
            
            if (data.success && data.backups.length > 0) {
                let html = '<div class="list-group">';
                
                data.backups.forEach(backup => {
                    const date = new Date(backup.created_at).toLocaleString('ar-SA');
                    const size = formatFileSize(backup.size);
                    
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${backup.filename}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> ${date} | 
                                    <i class="fas fa-hdd"></i> ${size}
                                </small>
                            </div>
                            <div class="btn-group" role="group">
                                <a href="/admin/backup/download/${backup.filename}" 
                                   class="btn btn-sm btn-outline-primary" title="ุชุญููู">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-success" 
                                        onclick="restoreBackup('${backup.filename}')" title="ุงุณุชุนุงุฏุฉ">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteBackup('${backup.filename}')" title="ุญุฐู">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                backupsList.innerHTML = html;
            } else {
                backupsList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-database fa-2x text-muted mb-2"></i>
                        <p class="text-muted">ูุง ุชูุฌุฏ ูุณุฎ ุงุญุชูุงุทูุฉ</p>
                        <small class="text-muted">ุงุจุฏุฃ ุจุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฌุฏูุฏุฉ</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('backupsList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
                </div>
            `;
        });
}

// ุชูุณูู ุญุฌู ุงูููู
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ุญุฐู ูุณุฎุฉ ุงุญุชูุงุทูุฉ
function deleteBackup(filename) {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ')) {
        fetch(`/admin/backup/delete/${filename}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshBackupsList();
                showAlert('ุชู ุญุฐู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ', 'success');
            } else {
                showAlert('ุญุฏุซ ุฎุทุฃ: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู', 'danger');
        });
    }
}

// ุญุฐู ุงููุณุฎ ุงููุฏููุฉ
function cleanOldBackups() {
    if (confirm('ูู ุชุฑูุฏ ุญุฐู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงูุฃูุฏู ูู 30 ูููุ')) {
        fetch('/admin/backup/clean', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshBackupsList();
                showAlert(`ุชู ุญุฐู ${data.deleted_count} ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุฏููุฉ`, 'success');
            } else {
                showAlert('ุญุฏุซ ุฎุทุฃ: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุธูู', 'danger');
        });
    }
}

// ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
function restoreBackup(filename) {
    const confirmMessage = `โ๏ธ ุชุญุฐูุฑ ููู โ๏ธ

ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ูุฐู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ

${filename}

ุณูุชู:
โข ุงุณุชุจุฏุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ ุจุงููุงูู
โข ููุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงููุถุงูุฉ ุจุนุฏ ุชุงุฑูุฎ ูุฐู ุงููุณุฎุฉ
โข ุฅูุดุงุก ูุณุฎุฉ ุฃูุงู ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ ุชููุงุฆูุงู

ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!`;

    if (confirm(confirmMessage)) {
        // ุชุฃููุฏ ุฅุถุงูู
        if (confirm('ุชุฃููุฏ ุฃุฎูุฑ: ูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ูุน ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ')) {
            const restoreBtn = event.target.closest('button');
            const originalContent = restoreBtn.innerHTML;
            
            restoreBtn.disabled = true;
            restoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            fetch(`/admin/backup/restore/${filename}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('โ ' + data.message, 'success');
                    showAlert('๐ ูููุตุญ ุจุฅุนุงุฏุฉ ุชุดุบูู ุงููุธุงู ูุถูุงู ุนูู ุฌููุน ุงูููุฒุงุช ุจุดูู ุตุญูุญ', 'info');
                    refreshBackupsList();
                } else {
                    showAlert('โ ุญุฏุซ ุฎุทุฃ: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุณุชุนุงุฏุฉ', 'danger');
            })
            .finally(() => {
                restoreBtn.disabled = false;
                restoreBtn.innerHTML = originalContent;
            });
        }
    }
}

// ุนุฑุถ ุฑุณุงูุฉ ุชูุจูู
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    // ุฅุฒุงูุฉ ุงูุชูุจูู ุจุนุฏ 5 ุซูุงูู
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// ูุนุงูุฌุฉ ูููุฐุฌ ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
document.getElementById('backupForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('createBackupBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฅูุดุงุก...';
    
    // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ ุจุนุฏ 5 ุซูุงูู
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ';
        refreshBackupsList();
    }, 5000);
});
</script>
{% endblock %}